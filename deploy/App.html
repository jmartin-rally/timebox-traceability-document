<!DOCTYPE html>
<html>
<head>
    <title>System Requirements</title>

    <script type="text/javascript" src="/apps/2.0p5/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
            // Create the namespace
            Ext.ns('Ext.ux.plugins.grid');
            
            /**
             * Ext.ux.plugins.grid.stripeCols plugin for Ext.grid.GridPanel
             *
             * A GridPanel plugin that enables alternating cell formatting
             * in grids by setting 'stripeCols: true', similar to the
             * stripeRows option.
             *
             * To omit certain columns from being striped, you can pass the
             * parameter 'excludeCStripe: ['col1',...]' to the grid config,
             * listing all data indexes that should be left out. Note that
             * this doesn't affect the striping of other columns.
             *
             * To omit columns from being striped but stripe the immediately
             * following one, use the 'skipCStripe: ['col1',...]' parameter
             * instead.
             *
             * Release Date: March 23, 2009
             * @author  BitPoet
             * @date    December 22, 2011
             * @version 4.01
             * @changelog:
             * @version 4.01
             * @date       22-Dec-2011
             *             - Yaron Yogev (extjs id: yyogev): Migrated to ExtJS 4
             *
             * @class Ext.ux.plugins.grid.stripeCols
             * @extends Ext.util.Observable
             */
            Ext.ux.plugins.grid.stripeCols = Ext.extend( Ext.util.Observable, {
                init:
                function(grid) {
                    var v = grid /* grid.getView()*/;
                    if (typeof v != "object")
                        Ext.Msg.alert("Error", "stripeCols.init: view is not an object");
                    v.afterRender = Ext.Function.createSequence(v.afterRender, this.setCss);
                    v.on('rowsinserted', Ext.Function.bind(this.setCss, v));
                    v.on('rowremoved', Ext.Function.bind(this.setCss, v));
                    grid.on('columnmoved', Ext.Function.bind(this.setCss, v));
                    grid.on('columnhide', Ext.Function.bind(this.setCss, v));
                    grid.on('columnshow', Ext.Function.bind(this.setCss, v));
                    v.on('refresh', Ext.Function.bind(this.setCss, v));
                }
                ,setCss:    function() {
                    for(var j = 0; j < this.store.getCount(); j++) {
                        var markop = 1;
                        var r = this.store.getAt(j);
                        if (!r)
                            continue;
                        var columns = this.getGridColumns();
                        var column_count = columns.length;
                        for (var i = 0; i < column_count; i++) {
                            var cell = this.getCell(r, this.getHeaderAtIndex(i));
            
                            var header = this.getHeaderAtIndex(i);
                            var stripe_exclude = this.excludeCStripe &&
                                this.excludeCStripe.indexOf(header.dataIndex) != -1;
                            if (this.stripeCols && i % 2 == markop  && !stripe_exclude) {
                            	if( Ext.Element.get(cell) ) {
                                    cell.removeCls('x-grid3-col-alt');
                                }
                            } else {
                                var stripe_skip = this.skipCStripe &&
                                this.skipCStripe.indexOf(header.dataIndex) != -1;
            	                if (header.isHidden() || stripe_skip)
            	                {
            	                    markop ^= 1;
            	                } else {
            	                    if( Ext.Element.get(cell) ) {
            	                        cell.addCls('x-grid3-col-alt');
            	                    }
            	                }
                            
                                
                            }
                        }
                    }
                }
            });
            /* EOF Ext.ux.plugins.grid.stripeCols */
            
            /*
             * CompletenessByCount/ByPoints for items that have no children but are
             * accepted should be 100%
             */
            var convertAcceptedOrphan = function(value, record) {
            	if ( record.data.ScheduleState === "Accepted" ) {
            		return 1;
            	} else {
            		return value;
            	}
            };
            
            Ext.define('Summary',{
            	extend: 'Ext.data.Model',
            	fields: [
                     { name: 'Name', type: 'string' },
                     { name: '_ref', type: 'string' },
                     { name: 'FormattedID', type: 'string' },
                     { name: 'ObjectID', type: 'int' },
                     { name: 'ScheduleState', type: 'string' },
                     { name: 'Description', type: 'string' },
                     { name: 'AcceptedDate', type: 'date' },
                     { name: 'PlanEstimate', type: 'float' },
                     { name: 'ProjectName', type: 'string', defaultValue: '--' },
                     { name: 'ParentID', type: 'int', defaultValue: 0 },
                     { name: 'CompletenessByCount', type: 'float', defaultValue: 0, min: 0, max: 1, convert: convertAcceptedOrphan },
                     { name: 'CompletenessByPoints', type: 'float', defaultValue: 0, min: 0, max: 1, convert: convertAcceptedOrphan },
                     { name: 'CountChildren', type: 'int', defaultValue: 0, min: 0 },
                     { name: 'CountTests', type: 'int', defaultValue: 0, min: 0 },
                     { name: 'CountPassedTests', type: 'int', defaultValue: 0 },
                     { name: 'CompletenessByTests', type: 'float', defaultValue: 0, min: 0, max: 1 },
                     { name: 'CountAcceptedChildren', type: 'int', defaultValue: 0, min: 0 },
                     { name: 'SumAcceptedChildren', type: 'float', defaultValue: 0, min: 0 }
                ],
                hasMany: [ { model: 'User Story', name: 'Children' }, { model: 'Test Case', name: 'TestCases' } ],
                addTestCases: function( tc_array ) {
                	var that = this;
                	Ext.Array.each( tc_array , function(tc) {that.addTestCase(tc);});
                },
                addTestCase: function( tc ) {
                	var tc_count = this.get('CountTests') + 1;
                	var pass_count = this.get('CountPassedTests');
                	
                	this.set('CountTests', tc_count);
                	if ( tc.LastVerdict === "Pass" ) {
                		pass_count += 1;
                		this.set('CountPassedTests', pass_count );	
                	}
                	this.set('CompletenessByTests', pass_count / tc_count );
            
                	if ( this.get('TestCases') ) {
                		var tests = this.get('TestCases');
                		tests.push(tc);
                		this.set('TestCases', tests );
                	} else {
                		this.set('TestCases', [tc]);
                	}
                },
                addChild: function( child ) {
                	var child_count = this.get('CountChildren') + 1;
                	this.set( 'CountChildren', child_count );
                	if ( child.ScheduleState === "Accepted" ) {
                		var accepted_total = this.get('CountAcceptedChildren') + 1;
                		var accepted_points = this.get('SumAcceptedChildren');
                		
                		this.set('CountAcceptedChildren', accepted_total );
                		this.set('CompletenessByCount', accepted_total / child_count );
                		if (child.PlanEstimate && child.PlanEstimate > 0 ) { 
                			accepted_points += child.PlanEstimate;
                			this.set('SumAcceptedChildren',accepted_points);
                			this.set('CompletenessByPoints', accepted_points/this.get('PlanEstimate') );
                		}
                	}
                	if (this.get('Children')) {
                		var kids = this.get('Children');
                		kids.push(child);
                		this.set('Children', kids );
                	} else {
                		this.set('Children', [ child ] );
                	}
                },
                getFormattedChildren: function() {
                	var formatted_text = null;
                	if ( this.get('Children') ) {
                		var text_array = [];
                		Ext.Array.each( this.get('Children'), function(child) {
                			var tc_count = child.TestCases.length || 0;
                			var child_text = child.FormattedID + ": " + child.Name + " (" + 
                				tc_count + " Test Cases)";
                			text_array.push( child_text );
                		});
                		formatted_text = text_array.join("<br/>");
                	} else {
                		formatted_text = "No children stories";
                	}
                	return formatted_text;
                }
            });            var nameRenderer = function(value, metaData, record, rowIndex, colIndex, store, view) {
                var item = record.getData();
                var url = Rally.util.Navigation.createRallyDetailUrl(item);
                var formatted_string = "<a target='_top' href='/#" + url + "'>" + item.FormattedID + "</a>: " + item.Name;
                if ( item.ParentID > 0 ) { 
                    formatted_string = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" + formatted_string
                }
                return formatted_string;  
            };
            
            Ext.define('CustomApp', {
                extend: 'Rally.app.App',
                componentCls: 'app',
                defaults: { margin: 5 },
                items: [ 
                        { xtype: 'container', itemId: 'selector_box' },
            	        { xtype: 'container', itemId: 'summary_box' } ,
                        { xtype: 'container', itemId: 'detail_box' }
                ],
                launch: function() {
                    //Write app code here
                    this._addSelector();
                	//this._getMarkedStories();
                },
                _addSelector: function() {
                    var that = this;
                    var range_types = Ext.create('Ext.data.Store',{
                        fields: ['name'],
                        data: [
                        { 'name': 'Iteration' },
                        { 'name': 'Release' }
                        ]
                    });
                    this.down('#selector_box').add(Ext.create('Ext.form.ComboBox', {
                        fieldLabel: '',
                        store: range_types,
                        queryMode: 'local',
                        displayField: 'name',
                        valueField: 'name',
                        value: 'Release',
                        listeners: {
                            change: function( field, newValue, oldValue, opts ) {
                                that._addSubselector(newValue);
                            },
                            added: function( field, container ) {
                                that._addSubselector(field.getValue());
                            }
                        }
                    }));  
                },
                _addSubselector: function(rangeType) {
                    window.console && console.log( "_addSubselector", rangeType );
                    var that = this;
                    if ( this.subselector ) { 
                        this.subselector.destroy();
                    }
                    
                    if ( rangeType == "Iteration" ) {
                        this.subselector = Ext.create('Rally.ui.combobox.IterationComboBox',{
                            value: null,
                            listeners: {
                                ready: function( field ) {
                                    that.timebox = field.getRecord().data;
                                    that.title = "<strong>Summary Status: " + that.timebox.Name + "</strong>";
                                    that._getMarkedStories(rangeType);
                                },
                                change: function( field, newValue, oldValue, eOpts ) {
                                    that.timebox = field.getRecord().data;
                                    that.title = "<strong>Summary Status: " + that.timebox.Name + "</strong>";
                                    that._getMarkedStories(rangeType);
                                }
                            }
                        });
                        this.down('#selector_box').add(this.subselector);
                    } else if ( rangeType == "Release" ) {
                        this.subselector = Ext.create('Rally.ui.combobox.ReleaseComboBox',{
                            value: null,
                            listeners: {
                                ready: function( field ) {
                                    that.timebox = field.getRecord().data;
                                    that.title = "<strong>Summary Status: " + that.timebox.Name + "</strong>";
                                    that._getMarkedStories(rangeType);
                                },
                                change: function( field, newValue, oldValue, eOpts ) {
                                    that.timebox = field.getRecord().data;
                                    that.title = "<strong>Summary Status: " + that.timebox.Name + "</strong>";
                                    that._getMarkedStories(rangeType);
                                }
                            }
                        });
                        this.down('#selector_box').add(this.subselector);
                    } 
                },
                _clearBoxes: function() {
                    Ext.Array.each ( this.down('#summary_box').items.items, function(item) { 
                        if ( item ) {  item.hide(); }
                    });
                    
                    Ext.Array.each( this.down('#detail_box').items.items, function(item){
                       if (item) { item.hide(); } 
                    });
                },
                _getMarkedStories: function(rangeType) {
                	window.console && console.log( "_getMarkedStories", rangeType );
                    this._clearBoxes();
                    
                	//var filters = [ { property: rangeType + '.Name', operator: '=', value: this.timebox.Name }];
                	this.stories = Ext.create( 'Rally.data.WsapiDataStore', {
                		autoLoad: true,
                		model: 'User Story',
                		//filters: filters,
                		listeners: {
                			load: function(store,data,success) {
                				this._formatData(data);
                			},
                			scope: this
                		},
                		fetch: [ 'Name', 'ScheduleState', 'ObjectID', 'PlanEstimate', 
                            'FormattedID', 'AcceptedDate', 'Description', 'Project',
                            'TestCases', 'LastVerdict', 'LastRun', 'Children', rangeType ]
                	});
                },
                _formatData: function(data) {
                    // given a bunch of parents with their children
                    window.console && console.log( "_formatData", data, this.timebox);
                    
                    var that = this;
                    var timebox_type = this.timebox._type[0].toUpperCase() +  this.timebox._type.slice(1);
                    var summaries = {};
                    Ext.Array.each( data, function(story_shell) {
                        var story = story_shell.data;
            	        var summary = Ext.create('Summary', story);
            	        summary.set('ProjectName', story.Project.Name );
            	        summary.addTestCases(story.TestCases);
                        summaries[ story.ObjectID ] =  summary ;
            
                        Ext.Array.each( story.Children, function(child) {                
                            if ( child[timebox_type] && child[timebox_type].Name === that.timebox.Name ) {
            	                // add to parent
            	                summary.addChild( child );
            	                var child_summary = Ext.create('Summary', child);
            	                child_summary.set('ParentID',story.ObjectID);
            	                child_summary.set('ProjectName', child.Project.Name );
            	                child_summary.addTestCases(child.TestCases);
            	                summary.addTestCases(child.TestCases); // also update parent
            	                summaries[ child.ObjectID ] = child_summary;
                            }
                        });
                    });
                    
                    window.console && console.log( 'summaries', summaries );
                    
                    var sorted_summary = this._hashToArray(summaries);
                    
                    var store = Ext.create( 'Rally.data.custom.Store', {
                        data: sorted_summary
                    });
                    this._makeSummaryGrid(summaries,store);
                },
                _makeSummaryGrid: function(summaries,store) {
                	window.console && console.log('_makeSummaryGrid');
                    var that = this;
                    var grid = Ext.create('Rally.ui.grid.Grid', {
                        store: store,
                        width: 600,
                        showPagingToolbar: false,
                        columnCfgs: [
                            { text: 'Name', dataIndex: 'Name', sortable: false, renderer: nameRenderer, flex: 1 },
                            { text: 'Acceptance Rate',
            				    xtype: 'templatecolumn',
            				    tpl: Ext.create('Rally.ui.renderer.template.PercentDoneTemplate', {
            				         percentDoneName: 'CompletenessByPoints'
            				    })
                            },
                            { text: 'Passed Tests',
                                xtype: 'templatecolumn',
                                tpl: Ext.create('Rally.ui.renderer.template.PercentDoneTemplate', {
                                     percentDoneName: 'CompletenessByTests'
                                })
                            },
                            { text: 'Accepted Date', dataIndex: 'AcceptedDate', sortable: false }
                        ]
                    });
            
                    this.down('#summary_box').add(
                        { xtype: 'component', renderTpl: this.title, cls: 'head1', width: 600, padding: 5 } );
                    
                    this.down('#summary_box').add(grid);
                    
                    for ( var i in summaries ) {
                        if ( summaries.hasOwnProperty(i) ) {
                            if ( summaries[i].getData().ParentID == 0 ) {
                                that._makeRequirementBox( summaries[i] );
                            }
                        }
                    }
                },
                _makeRequirementBox: function( requirement ) {
                    window.console && console.log( "_makeRequirementBox", requirement );
                    var that = this;
                    var store = Ext.create('Rally.data.custom.Store', {
                        data: [
                            { Label: 'Specification:', Value: requirement.get("FormattedID") + ": " + requirement.get("Name" ) },
                            { Label: 'Description:', Value: requirement.get("Description")},
                            { Label: 'Functional Stories', Value: requirement.getFormattedChildren() }
                        ]
                    });
                    
                    var grid = Ext.create('Rally.ui.grid.Grid', {
                        width: 710,
                        store: store,
                        showPagingToolbar: false,
                        viewConfig: {
                            stripeCols: true,
                            plugins: [ new Ext.ux.plugins.grid.stripeCols() ]
                        },
                        columnCfgs: [
            	            { dataIndex: 'Label', sortable: false },
            	            { dataIndex: 'Value', sortable: false, flex: 1 }
                        ]
                    } );
                    
                    this.down('#detail_box').add(
                    { 
                        xtype: 'component', 
                        renderTpl: "System Requirement", 
                        cls: 'head1', 
                        width: 710, 
                        padding: 5
                    });
                    this.down('#detail_box').add(grid);
                    
                    var stories = requirement.get('Children');
                    Ext.Array.each(stories, function(story) {
                        var test_cases = story.TestCases;
                        Ext.Array.each(test_cases, function(test_case) {
                            that._makeTestCaseBox(story, test_case);
                        });
                    });
                },
                _makeTestCaseBox: function(story, test_case) {
                    window.console && console.log("_makeTestCaseBox", test_case);  
                    var store = Ext.create( 'Rally.data.custom.Store', {
                        data: [
                        { Label: 'Test Case:', Value: test_case.FormattedID + ": " + test_case.Name },
                        { Label: 'Story:', Value: story.FormattedID + ": " + story.Name },
                        { Label: 'Test Case Description:', Value: test_case.Description },
                        { Label: 'Last Run:', Value: test_case.LastRun + " (" + test_case.LastVerdict + ")" }
                        ]
                    });
                   
                    var grid = Ext.create('Rally.ui.grid.Grid', {
                        width: 700,
                        store: store,
                        showPagingToolbar: false,
                        viewConfig: {
                            stripeCols: true,
                            plugins: [ new Ext.ux.plugins.grid.stripeCols() ]
                        },
                        columnCfgs: [
                            { dataIndex: 'Label', sortable: false },
                            { dataIndex: 'Value', sortable: false, flex: 1 }
                        ]
                    } );
                    
                    this.down('#detail_box').add( { xtype: 'container', margin: 15, itemId: 'x' + test_case.FormattedID });
                    
                    this.down('#x' + test_case.FormattedID).add(
                    { 
                        xtype: 'component', 
                        renderTpl: "Test Case", 
                        cls: 'head1', 
                        width: 700, 
                        padding: 5
                    });
                    this.down('#x' + test_case.FormattedID).add(grid);
                },
                _hashToArray: function(hash) {
                    var theArray = [];
                    for ( var i in hash ) {
                        if ( hash.hasOwnProperty(i) ) {
                            theArray.push(hash[i]);
                        }
                    }
                    return theArray;
                },
                _hashToArrayByParent: function( summary_hash ) {
                    var sorted_array = [];
                    
                    for ( var id in summary_hash ) {
                        if ( summary_hash.hasOwnProperty(id) ) {
                            var summary = summary_hash[id];
                            if ( summary.getData().ParentID === 0 ) {
                                sorted_array.push( summary );
                                if ( summary.getData().CountChildren > 0 ) {
                                    Ext.Array.each( summary.get('Children'), function(child) {
                                        if ( child.Parent && summary_hash.hasOwnProperty(child.ObjectID ) ) {
                                           sorted_array.push( summary_hash[child.ObjectID]); 
                                        }
                                    });
                                }
                            }
                        }
                    }
            
                    return sorted_array;
                }
            });

            Rally.launchApp('CustomApp', {
                name: 'System Requirements'
            });
        });
    </script>

    <style type="text/css">
        .app {
             /* Add app styles here */
        }
        .head1 {
        	background-image: url(https://rally1.rallydev.com/apps/2.0p5/rui/resources/themes/images/default/grid/columnheader-bg-gr_45.png);
        	background-size: auto;
        	background-color: #EFF8FB;
        	color: #085478;
        	font-size: 150%;
        	margin-top: 10px;
        }
        .x-grid3-col-alt {
        	background-image: url(https://rally1.rallydev.com/apps/2.0p5/rui/resources/themes/images/default/grid/columnheader-bg-gr_45.png);
        	background-size: auto;
        	background-color: #EFF8FB;}
        .x-grid3-row-alt .x-grid3-col-alt {
            background-color:#eaeaea !important;
        }
        
    </style>
</head>
<body></body>
</html>
